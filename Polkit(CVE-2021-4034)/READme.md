# Pwnkit (CVE-2021-4034)
## @Author : M3tr1c_r00t

![image](https://user-images.githubusercontent.com/99975622/218460904-018ae89f-e906-482b-a72a-88bf5fb59e6e.png)


### Background
pwnkit was discovered in january 2022.
The vulnerability existed in every version of the "Policy Toolkit" package since it was released in 2009.
It is found in every linux distro by default.

The exploit only works locally hence is a Local Priviledge Escalation Vulnerability.

Polkit is part of the linux authorization system.
It is intergrated using systemd and is much more configurable that the traditional sudo system.

When interacting with polkit, we use the pkexec utility whihc contains the vulnerability.

The polkit vulnerability can be thought of as a fine grained alternative to the simpler sudo system.

### The vulnerability.
The unpatched pkexec versions dont handle command-line arguments safely, which leads to an "out-of-bounds write" vulnerability, allowing an attacker to manipulate the environment with which pkexec is run.

pkexec attempts to parse any command-line arguments that we pass it using a for-loop, starting at an index of 1 to offset the name of the program and obtain the first real argument (e.g. if we entered pkexec bash, then as pkexec is the name of the program, it would be argument 0 — the actual command-line arguments start at index 1). The name of the program is irrelevant to argument parsing, so the indexing is simply offset to ignore it. 

If we dont provide any arguments, the index is set permanently to 1.

For example;
```
for(n=1; n < number_of_arguments; n++){
  //Do Stuff
}
```

If the number of arguments is 0 then n is never less than the number of arguments. As such, n stays equal to one and the loop is bypassed completely.

This becomes a problem later when pkexec attempts to write to the value of the argument at index n. As there are no command-line arguments, there is no argument at index n — instead the program overwrites the next thing in memory, which just so happens to be the first value in the list of environment variables when the program is called using a C function called execve(). In other words, by passing pkexec a null list of arguments, we can force it to overwrite an environment variable instead!

certain "dangerous" environment variables are removed by the operating system when you attempt to run a program that has the SUID bit set (as pkexec does by necessity); this is to prevent attackers from being able to hijack the program as it runs with administrative permissions. Using the out-of-bounds write, we are able to re-introduce our choice of these dangerous environment variables by tricking pkexec into adding it for  us.

### Patching
we can update and upgrade the system.
```
sudo apt update && sudo apt upgrade
```

We can also remove the suid bit from the pkexec binary.
This works as a temporary solution if the distro you are using hasnt released the patch.
```
sudo chmod 0755 `which pkexec`
```

NB:// We can also make our very own exploit script using any language and i'm gonna attach a custom crafted one using python and ruby.

### References
```
https://www.qualys.com/2022/01/25/cve-2021-4034/pwnkit.txt
```

## My socials:
<br>@ twitter: https://twitter.com/M3tr1c_root
<br>@ instagram: https://instagram.com/m3tr1c_r00t/
