SSRF - Server side Request Forgery
This vulnerability allows a malicioususer to casue the web-server make aditional or edited HTTP request to the resource that the web-server is choosing.

## Types of SSRF
- Regulat SSRF - is Where data is returned to the attackers screen/client side.
- Blind SSRF - Is where an SSRF occurs but no information is returned to the attacker.


### Ways To Identify SSRF
- When a full url is used in a parameter in the address bar.
- Finding a hidden field in a form
- SSRF via the Referer header
- URLs within data formats e.g XML data format. you can also change an xxe to an ssrf

If working with a blind SSRF where no output is reflected back to you, you'll need to use an external HTTP logging tool to monitor requests such as requestbin.com, your own HTTP server or Burp Suite's Collaborator client.

**RequestBin.com** - an external web-site one can use to catch http requests from a server.

-   Files - The attacker may be able to read files using `file://` URIs.
### Common SSRF Defenses
#### 1). Blacklisting
- In a blacklist, all requests are accepted apart from resources specified in a list or matching a particular pattern.
- The black-listed entities may include :
	 - localhost
	 - 127.0.0.1
- As attackers, we can bypass that by:
	- using alternative localhost references such as 0, 0.0.0.0, 0000, 127.1, 127.*.*.*, 2130706433, 017700000001.
	- subdomains that have a DNS record which resolves to the IP Address 127.0.0.1 such as 127.0.0.1.nip.io.(Legit ones)
	-  Obfuscating blocked strings using URL encoding or case variation.
	- Try using different protocols.

#### 2). Whitelisting
-  Is where all requests get denied unless they appear on a list or match a particular pattern
- You can leverage the DNS naming hierarchy to place required input into a fully-qualified DNS name that you control. For example: - An attacker could quickly circumvent this rule by creating a subdomain on an attacker's domain name, such as `https://expected-host.evil-host`. The application logic would now allow this input and let an attacker control the internal HTTP request.
- You can embed credentials in a URL before the hostname, using the `@` character. For example:
	-  `https://expected-host:fakepassword@evil-host`
- You can use the `#` character to indicate a URL fragment. For example:
	-  `https://evil-host#expected-host`
- You can URL-encode/double-encoding characters to confuse the URL-parsing code. This is particularly useful if the code that implements the filter handles URL-encoded characters differently than the code that performs the back-end HTTP request. 
- 
## SSRF attacks against the server itself

In this type of attack, the attacker induces the application to make an HTTP request back to the server that is hosting the application, via its loopback network interface. This will typically involve supplying a URL with a hostname like `127.0.0.1` (a reserved IP address that points to the loopback adapter) or `localhost` (a commonly used name for the same adapter).

We can consider this post requests to a sites shopping app.

In this case, we are checking the stuff inside the shopping cart.
```
POST /product/stock HTTP/1.0 
Content-Type: application/x-www-form-urlencoded 
Content-Length: 118 

stockApi=http://stock.weliketoshop.net:8080/product/stock/check%3FproductId%3D6%26storeId%3D1
```

Since we can see its referring to itself directly, we can actually manipulate the request to get access to the login page if there is no filtering.

```
POST /product/stock HTTP/1.0 
Content-Type: application/x-www-form-urlencoded 
Content-Length: 118 

stockApi=http://localhost/admin
```

The server will be able to fetch the contents of the /admin url and return it to the user since we cant visit directly due to some checks.


##### Why will this work?
-   The access control check might be implemented in a different component that sits in front of the application server. When a connection is made back to the server itself, the check is bypassed.
-   For disaster recovery purposes, the application might allow administrative access without logging in, to any user coming from the local machine. This provides a way for an administrator to recover the system in the event they lose their credentials. The assumption here is that only a fully trusted user would be coming directly from the server itself.
-   The administrative interface might be listening on a different port number than the main application, and so might not be reachable directly by users.

## SSRF attacks  against other back-end systems.

In this case is where the application server is able to interact with other back-end systems that are not directly reachable by users. 

Probably a private IP address only accessible in the internal network.

Since the back-end systems are normally protected by the network topology, they often have a weaker security posture. In many cases, internal back-end systems contain sensitive functionality that can be accessed without authentication by anyone who is able to interact with the systems.

### Note

In an SSRF, you wont be returned to data directy.  At some time it may be metadata or even the response which can be used to determine if the attack was successful or not.

Requests that are successful will tend to be markedly shorter than this baseline, and occasionally longer if the connection established is not secured by one of the parties.

From SSRF, various things can be done, such as:

-   Local/Remote Port Scan
-   Local File Read (using file://)
-   Interact with internal apps/service/network
-   RCE by chaining services on the internal network
-   Read Metadata Cloud (AWS, Azure, Google Cloud, Digital Ocean, etc)
-   Reflected XSS/CSRF

### Resources

```
https://learn.snyk.io/lessons/ssrf-server-side-request-forgery/javascript/

https://www.acunetix.com/blog/articles/server-side-request-forgery-vulnerability/

https://infosecwriteups.com/exploiting-server-side-request-forgery-ssrf-vulnerability-faeb7ddf5d0e
```

### rooms
#### THM
- SSRF
- The Great Escape
- MD2PDF
- IronCorp
#### HTB
- Spider
- Writer
- Forge
- Gobox
- Bolt
- Doctor
- Travel
- Ready
